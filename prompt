# Discord Fitness Tracker Bot â€” Claude Code Prompt

Build a Discord bot using **discord.js v14** and **SQLite (via better-sqlite3)** that tracks daily fitness activities with a dead-simple button-based UX. Use ESM modules throughout.

## Project Structure

```
Spotter/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js          # Bot entry, client setup, event registration
â”‚   â”œâ”€â”€ database.js        # SQLite schema, migrations, query helpers
â”‚   â”œâ”€â”€ commands/          # Slash command handlers
â”‚   â”‚   â”œâ”€â”€ addactivity.js # /addactivity <emoji> <name> â€” add custom activity
â”‚   â”‚   â”œâ”€â”€ removeactivity.js # /removeactivity <name> â€” remove a custom activity
â”‚   â”‚   â”œâ”€â”€ streak.js      # /streak [user] â€” show personal streak stats
â”‚   â”‚   â”œâ”€â”€ leaderboard.js # /leaderboard â€” top streaks (current + all-time)
â”‚   â”‚   â””â”€â”€ setup.js       # /setup â€” post the tracker panel in current channel
â”‚   â”œâ”€â”€ components/        # Button/interaction handlers
â”‚   â”‚   â””â”€â”€ activityButtons.js
â”‚   â”œâ”€â”€ scheduler.js       # Daily scheduled tasks (panel repost, streak summary)
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ streakCalc.js  # Streak calculation logic
â”‚       â””â”€â”€ embeds.js      # Reusable embed builders
â”œâ”€â”€ .env                   # DISCORD_TOKEN, GUILD_ID, CHANNEL_ID
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## Database Schema (SQLite)

```sql
-- Server-level activity definitions (defaults + custom)
CREATE TABLE activities (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  guild_id TEXT NOT NULL,
  name TEXT NOT NULL,
  emoji TEXT DEFAULT NULL,
  is_default BOOLEAN DEFAULT 0,
  created_by TEXT, -- user id who added it, NULL for defaults
  UNIQUE(guild_id, name)
);

-- One row per user per day per activity
CREATE TABLE activity_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  guild_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  activity_id INTEGER NOT NULL REFERENCES activities(id),
  logged_date TEXT NOT NULL, -- YYYY-MM-DD format
  logged_at TEXT NOT NULL,   -- ISO timestamp
  UNIQUE(guild_id, user_id, activity_id, logged_date)
);

-- Track which channels to post the daily panel + summary
CREATE TABLE tracked_channels (
  guild_id TEXT NOT NULL,
  channel_id TEXT NOT NULL,
  last_panel_message_id TEXT DEFAULT NULL, -- stores the message ID of the current panel so it can be deleted on repost
  PRIMARY KEY(guild_id, channel_id)
);
```

Seed default activities on first setup per guild: `ğŸ¦µ Legs`, `ğŸ«¸ Push`, `ğŸ«· Pull`, `â¬‡ï¸ Lower`, `â¬†ï¸ Upper`, `ğŸš¶ Walk`, `ğŸ˜´ Rest`.

## Core Features

### 1. Tracker Panel (the main UI)
- Posted via `/setup` and re-posted automatically every morning.
- An embed with a title like "ğŸ’ª Fitness Tracker â€” tap to log today's activity" and a brief subtitle showing today's date.
- Below the embed: rows of buttons, one per activity for that guild. Use the activity emoji as the button emoji and the name as the label. Use `ButtonStyle.Secondary` for most, `ButtonStyle.Success` for rest maybe.
- Discord limits: 5 buttons per ActionRow, 5 rows max (25 buttons per message). If a guild has >25 activities, split across two messages â€” first message gets the embed header + first 25 buttons, second message gets the remaining buttons (no embed, just buttons). Both messages' IDs should be tracked for deletion on repost.
- **When a button is clicked:**
  - Insert into `activity_logs` (upsert â€” ignore if already logged that activity today).
  - Reply with an **ephemeral** message: `"âœ… Logged **Push** for today! You're on a **12-day** streak ğŸ”¥"` (include current streak count).
  - If they already logged that same activity today, ephemeral reply: `"ğŸ‘ Already logged **Push** today!"`.
  - A user CAN log multiple different activities in a single day (e.g., Push + Walk). All count.

### 2. Streak Calculation (`streakCalc.js`)
- A "streak" = consecutive calendar days where the user logged **any activity (including Rest)**.
- Any log at all keeps the streak alive. A day with zero logs breaks the streak.
- Expose two values: `currentStreak` and `bestStreak` (all-time max).
- Store/cache best streak in a summary table or just compute from logs (fine for small scale).

### 3. Slash Commands

**`/setup`** â€” Posts the tracker panel in the current channel and registers it for daily reposts. Requires Manage Channel permission.

**`/addactivity emoji:<string> name:<string>`** â€” Adds a custom activity for this server. Emoji is optional. Rebuilds/edits the tracker panel to include it.

**`/removeactivity name:<string>`** â€” Removes a custom (non-default) activity. Autocomplete on existing custom activities.

**`/streak [user]`** â€” Shows an embed with:
  - Current streak (days)
  - Best streak (all-time)
  - Total active days
  - Activity breakdown (how many times each activity was logged, all-time)
  - A simple text-based heatmap/calendar of the last 30 days, e.g., using emoji squares: ğŸŸ© = active (non-rest logged), ğŸŸ¦ = rest only, â¬› = no log.

**`/leaderboard`** â€” Embed showing:
  - ğŸ”¥ **Current Streaks** â€” top 10 users by active current streak
  - ğŸ† **All-Time Best** â€” top 10 users by best-ever streak
  - Format each row like: `1. @username â€” 23 days ğŸ”¥`

### 4. Scheduled Daily Tasks (`scheduler.js`)
Use `setInterval` or a cron-like approach (e.g., check every minute, fire at target hour). Run daily at a configurable time (default: 8:00 AM UTC).

**Daily panel repost:** For each tracked channel: fetch `last_panel_message_id` from DB, attempt to delete that message (catch & ignore if already deleted or missing), post a fresh tracker panel, and update `last_panel_message_id` in the DB with the new message ID. Old panels from crashed/missed deletions won't break anything â€” their buttons still work, they just won't be auto-cleaned.

**Daily streak summary:** Post an embed in tracked channels:
  - Title: "ğŸ“Š Active Streaks â€” [date]"
  - List all users with an active streak â‰¥ 2 days, sorted descending.
  - Format: `ğŸ”¥ @user â€” 15 days | ğŸ’ª @user2 â€” 7 days | ...`
  - If no one has a streak, skip posting.

### 5. Encouragement / Nudges (modular rule system)

Create a file `src/utils/encouragement.js` that exports an array of encouragement rule functions. Each rule is a standalone function with this signature:

```js
/**
 * @param {Object} context
 * @param {number} context.currentStreak - user's current streak count
 * @param {string} context.activityName - the activity just logged (e.g., "Rest", "Push")
 * @param {string[]} context.recentActivities - activity names for last 7 days (index 0 = today), null for days with no log
 * @param {boolean} context.hadStreakYesterday - whether user had an active streak going into today
 * @returns {string|null} - message to append, or null to skip
 */
```

The button click handler collects context, runs all rules, and appends any non-null messages to the ephemeral reply. Rules are evaluated in array order; all matching rules fire (not just the first).

**Ship these default rules (ordered by priority â€” important context first, celebrations last):**

1. **`comebackAfterMissedDay`** â€” Fires when today's log exists but yesterday had no log at all (and the user had a streak before the gap). Returns: `"Welcome back! Streak reset to 1, but let's build it back ğŸ’ª"`.

2. **`consecutiveRest`** â€” Fires when the last 3+ logged days are ALL "Rest" (no non-rest activity in those days). Returns: `"You've been resting for 3 days straight â€” ready to get back at it? ğŸ’ª"`. (Scales the day count dynamically.)

3. **`firstLog`** â€” Fires when `currentStreak === 1` and the user has no prior logs at all. Returns: `"First log! The journey of a thousand days starts with one ğŸš€"`.

4. **`streakMilestone`** â€” Fires when `currentStreak` hits 7, 14, 30, 50, 100. Returns messages like `"ğŸ‰ **7-day streak!** One full week, legend!"`.

**To add a new rule:** just write a function matching the signature and push it into the exported array. No other files need to change.

## Implementation Notes

- Use `better-sqlite3` (synchronous SQLite wrapper, simpler than async alternatives for this scale).
- Register slash commands on startup using `REST.put(Routes.applicationGuildCommands(...))` for dev, or application-wide for prod.
- Use `client.on('interactionCreate')` to route both slash commands and button interactions.
- Button custom IDs should encode the activity, e.g., `log_activity:<activity_id>`.
- All times/dates should be in **UTC** for consistency. Use `new Date().toISOString().slice(0, 10)` for the date string.
- Use embeds liberally â€” they look way better than plain text.
- Include a `.env.example` with the required env vars.
- Write a `README.md` with setup instructions: how to create a Discord app, get a token, invite the bot (with required permissions: Send Messages, Use Slash Commands, Embed Links, Read Message History), and run it.

## Bot Permissions / Intents
- Intents: `Guilds`, `GuildMessages` (you don't need message content intent).
- Permissions: Send Messages, Embed Links, Use External Emojis, Read Message History.

## Error Handling
- Wrap all interaction handlers in try/catch. If something fails, reply ephemeral with a friendly error.
- Handle the "interaction already acknowledged" edge case (defer reply if processing might be slow).

## What NOT to build (keep it simple)
- No web dashboard.
- No DM-based reminders (too intrusive).
- No image/chart generation for v1 â€” the emoji grid in `/streak` is enough.
- No per-user custom activities â€” activities are per-server.
- No undo/delete log button for now.